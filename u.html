<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        @import url("/styles/main.css");
    </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.7/dist/sweetalert2.all.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-analytics.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-app.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-auth.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-database.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/scripts/firebase.js"></script>

<body>

    <mobile-header>

    </mobile-header>
    <header class="full-wh center-flex" header>

    </header>
    <profile-info class="center-flex relative">
        <banner class="center-flex relative">
            <non-ag class="full-wh full-bg center-flex absolute" id="user_banner">

            </non-ag>
            <non-a class="second full-wh full-bg center-flex absolute ">

            </non-a>
            <non-b class="full-wh full-bg center-flex absolute" id="user_banner">
                <add_verified class=" center-flex">
                    <nonv add_verified style="display: none;"></nonv>
                </add_verified>
                <upload-cover id="upload_banner_picture" class="center-flex">
                </upload-cover>
            </non-b>
        </banner>

        <profile-index class="absolute center-flex full-wh">
            <profile-pic id="user_profile_pic" class="full-bg center-flex">

            </profile-pic>
            <user-name>
                <non id="user_name">
                    <loadin import_small_loader>

                    </loadin>
                </non>
                <badge class="center-flex" id="user_badges">

                </badge>
            </user-name>
            <dex-c id="user_dec">
                <loadin import_small_loader>

                </loadin>
            </dex-c>
            <buttons>
                <buttons-x>
                    <non id="user_status">
                        <loadin import_small_loader>

                        </loadin>
                    </non>
                    <non id="following_button" class="following">

                    </non>
                    <non id="followers_button" class="followers">

                    </non>
                </buttons-x>

                <buttons-x id="if_follo_or_null">

                </buttons-x>
            </buttons>
        </profile-index>
    </profile-info>
    <grid-post class=" full-wh center-flex">
        <postx class=" center-flex">
            <postne style="background-image: url(/images/1.jpg);" class=" full-bg center-flex">

            </postne>
            <postne style="background-image: url(/images/2.jpg);" class=" full-bg center-flex">

            </postne>
            <postne style="background-image: url(/images/3.jpg);" class=" full-bg center-flex">

            </postne>
            <postne style="background-image: url(/images/4.jpg);" class=" full-bg center-flex">

            </postne>
            <postne style="background-image: url(/images/1.jpg);" class=" full-bg center-flex">

            </postne>
            <postne style="background-image: url(/images/2.jpg);" class=" full-bg center-flex">

            </postne>
            <postne style="background-image: url(/images/3.jpg);" class=" full-bg center-flex">

            </postne>
            <postne style="background-image: url(/images/4.jpg);" class=" full-bg center-flex">

            </postne>
        </postx>
    </grid-post>

    <script src="/scripts/com.js">
    </script>
    <input style="display: none;" id="uploadbanner" type="file" class="imgur" accept="image/*" data-max-size="5000" />
    <input style="display: none;" id="uploadpfp" type="file" class="imgur" accept="image/*" data-max-size="5000" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js">
    </script>
    <script data-cfasync="false" type="text/javascript">
        time = Date.now();
        time = time.toString();
        time = time.slice(0, -3);
        time = parseInt(time);

        var timeNow = time;

        function menuo() {
            var x = document.getElementById("menuo");
            x.style.height = "6.5rem";
            x.style.padding = "1rem";
        };

        function search_bar_close() {
            var x = document.getElementById("fsdfsdf");
            x.style.padding = "0rem";
        };

        function menuo_close() {
            var x = document.getElementById("menuo");
            x.style.height = "0rem";
            x.style.padding = "0rem";
        };


        function timeDifference(current, previous) {

            var sPerMinute = 60;
            var sPerHour = sPerMinute * 60;
            var sPerDay = sPerHour * 24;
            var sPerMonth = sPerDay * 30;
            var sPerYear = sPerDay * 365;

            var elapsed = current - previous;
            if (elapsed < sPerMinute) {
                var output = Math.round(elapsed);
                if (output == 1) {
                    return Math.round(elapsed) + ' sec ago';
                } else {
                    return Math.round(elapsed) + ' secs ago';
                }
            } else if (elapsed < sPerHour) {
                var output = Math.round(elapsed / sPerMinute);
                if (output == 1) {
                    return Math.round(elapsed / sPerMinute) + ' min ago';
                } else {
                    return Math.round(elapsed / sPerMinute) + ' mins ago';
                }
            } else if (elapsed < sPerDay) {
                var output = Math.round(elapsed / sPerHour);
                if (output == 1) {
                    return Math.round(elapsed / sPerHour) + ' hr ago';
                } else {
                    return Math.round(elapsed / sPerHour) + ' hrs ago';
                }
            } else if (elapsed < sPerMonth) {
                var output = Math.round(elapsed / sPerDay);
                if (output == 1) {
                    return Math.round(elapsed / sPerDay) + ' day ago';
                } else {
                    return Math.round(elapsed / sPerDay) + ' days ago';
                }
            } else if (elapsed < sPerYear) {
                var output = Math.round(elapsed / sPerMonth);
                if (output == 1) {
                    return Math.round(elapsed / sPerMonth) + ' month ago';
                } else {
                    return Math.round(elapsed / sPerMonth) + ' months ago';
                }
            } else {
                var output = Math.round(elapsed / sPerYear);
                if (output == 1) {
                    return Math.round(elapsed / sPerYear) + ' year ago';
                } else {
                    return Math.round(elapsed / sPerYear) + ' years ago';

                }
            }
        }
    </script>
    <script>
        //////////////////////////////////////// TIME JS PLUGIN ////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        var url = window.location.href;
        var id = url.substring(url.lastIndexOf('?id=') + 4);

        function bbedit() {
            var x = document.getElementById("followerlist");
            x.style.display = "block";
            var x = document.getElementById("datafoll");
            x.style.display = "none";
            var x = document.getElementById("datafolling");
            x.style.display = "none";
            var x = document.getElementById("dataedit");
            x.style.display = "block";
        };

        function following_button() {
            var x = document.getElementById("followerlist");
            x.style.display = "block";
            var x = document.getElementById("datafoll");
            x.style.display = "none";
            var x = document.getElementById("dataedit");
            x.style.display = "none";
            var x = document.getElementById("datafolling");
            x.style.display = "block";
        };

        function followers_button() {
            var x = document.getElementById("followerlist");
            x.style.display = "block";
            var x = document.getElementById("datafoll");
            x.style.display = "block";
            var x = document.getElementById("datafolling");
            x.style.display = "none";
            var x = document.getElementById("dataedit");
            x.style.display = "none";
        };

        function closex() {
            var x = document.getElementById("followerlist");
            x.style.display = "none";
        };



        firebase.database().ref('/data/users/').once('value', function(snapshot) {
            snapshot.forEach((user) => {
                var username = (user.val() && user.val().username);
                var userid = (user.val() && user.val().userid);
                var profile_picture = (user.val() && user.val().profile_picture);
                var onlineState = (user.val() && user.val().onlineState);

                $('[id=dname-' + userid + ']').text(username);
                $('[id=pfp-' + userid + ']').css('background-image', 'url(' + profile_picture + '),url(/icons/icon.png)');

                if (onlineState == true) {
                    $('[id=statuso-' + userid + ']').css('background-color', 'var(--c19)');
                    $('[id=statuosx-' + userid + ']').text('Online');
                } else {
                    $('[id=statuso-' + userid + ']').css('background-color', 'var(--c11)');
                    $('[id=statuosx-' + userid + ']').text('Offline');
                };

            })
        });
        $('body').on('click', function() {
            $('user-search').css("height", "0rem");
            $('user-search').css("padding", "0rem");
            $('non-ffg').css("height", "0rem");
        });
        $('[search_bar_close]').on('click', function() {
            $('user-search').css("height", "0rem");
            $('user-search').css("padding", "0rem");
            $('non-ffg').css("height", "0rem");
        });


        $('[search_users]').on("change", function() {
            var search_val = $('[search_users]').val();
            $('user-search').css("height", "auto");
            $('user-search').css("padding", "1rem");
            $('non-ffg').css("height", "auto");

            if (search_val == 0) {

                $('[import_search_data]').html("");
                setTimeout(
                    function() {
                        $('[import_search_data]').prepend('<nen>Not Found</nen>');
                    }, 0050);
            } else {
                firebase.database().ref('/data').child('users').orderByChild('username').startAt(search_val).on("value", function(snapshot) {
                    console.log(snapshot.val());
                    snapshot.forEach(function(data) {
                        console.log(data.val().username);
                        $('[import_search_data]').html("");
                        setTimeout(
                            function() {
                                $('[import_search_data]').prepend('<a href="/u?id=' + data.key + '">' + data.val().username + ' <nox class=" center-flex">' + data.val().status + '</nox></a>');
                            }, 0050);

                    });
                });
            }
        })

        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                ////////////////////////////////////////

                if (user.uid == 'YH2r7xe271Xv5yVbnBOHRMJVVmf2') {
                    $('[add_verified]').show();
                    $('[add_verified]').on('click', function() {
                        var db_ref = firebase.database().ref('/data/users/' + id).child('badges');
                        db_ref.once('value', function(snapshot) {
                            var verified = (snapshot.val() && snapshot.val().verified);
                            if (verified == true) {
                                db_ref.remove();
                            } else {
                                db_ref.update({
                                    verified: true,
                                });
                            };
                        });
                    });
                }


                /////////////////////////////////////////
                var user = firebase.auth().currentUser;
                if (id == user.uid) {
                    const data = '<non id="upload_banner_button">Upload Cover</non><non id="upload_profile_pic_button">Upload Profile Picture</non>';
                    $(data).appendTo($("[id=upload_banner_picture]"));
                    const datas = ' <non id="edit_profile" class="rambo">Edit Profile</non>';
                    $(datas).appendTo($("[id=if_follo_or_null]"));
                } else {
                    const data = ' <non id="follow_button" class="rambo">Follow</non>';
                    $(data).appendTo($("[id=if_follo_or_null]"));
                }
                console.log(user.uid);
                /////////////////////UPLOAD SYSTEM //////////////////////////////////
                $('[id=upload_profile_pic_button]').on('click', function() {
                    $('#uploadpfp').trigger('click');
                });
                $('[id=upload_banner_button]').on('click', function() {
                    $('#uploadbanner').trigger('click');
                });
                /////////////////////////////////////////////
                $("document").ready(function() {

                    $('input[id=uploadbanner]').on("change", function() {

                        var $files = $(this).get(0).files;

                        if ($files.length) {

                            // Reject big files
                            if ($files[0].size > $(this).data("max-size") * 1024) {
                                console.log("Please select a smaller file");
                                return false;
                            }

                            // Replace ctrlq with your own API key
                            var apiUrl = 'https://api.imgur.com/3/image';
                            var apiKey = '4b208caca83b4c4';

                            var formData = new FormData();
                            formData.append("image", $files[0]);

                            var settings = {
                                "async": true,
                                "crossDomain": true,
                                "url": apiUrl,
                                "method": "POST",
                                "datatype": "json",
                                "headers": {
                                    "Authorization": "Client-ID " + apiKey
                                },
                                "processData": false,
                                "contentType": false,
                                "data": formData,
                                beforeSend: function(xhr) {
                                    swal({
                                        text: "Uploading",
                                        buttons: false,
                                        closeOnClickOutside: false,
                                    });
                                },
                                success: function(res) {
                                    console.log(res.data.link);

                                    var user = firebase.auth().currentUser;
                                    var banner = res.data.link;
                                    $("document").ready(function() {

                                        firebase.database().ref('/data/users/' + user.uid).update({
                                            banner: banner
                                        });

                                    });
                                },
                                error: function() {

                                    swal("Failed | 上传失败");
                                }
                            }
                            $.ajax(settings).done(function(response) {
                                console.log("Done | 成功");
                                swal({
                                    title: "Done",
                                    icon: "success",
                                    timer: 1500,
                                });
                            });
                        }
                    });
                });
                //////////////////////////////////////////////
                $("document").ready(function() {

                    $('input[id=uploadpfp]').on("change", function() {

                        var $files = $(this).get(0).files;

                        if ($files.length) {

                            // Reject big files
                            if ($files[0].size > $(this).data("max-size") * 1024) {
                                console.log("Please select a smaller file");
                                return false;
                            }

                            // Replace ctrlq with your own API key
                            var apiUrl = 'https://api.imgur.com/3/image';
                            var apiKey = '4b208caca83b4c4';

                            var formData = new FormData();
                            formData.append("image", $files[0]);

                            var settings = {
                                "async": true,
                                "crossDomain": true,
                                "url": apiUrl,
                                "method": "POST",
                                "datatype": "json",
                                "headers": {
                                    "Authorization": "Client-ID " + apiKey
                                },
                                "processData": false,
                                "contentType": false,
                                "data": formData,
                                beforeSend: function(xhr) {
                                    swal({
                                        text: "Uploading",
                                        buttons: false,
                                        closeOnClickOutside: false,
                                    });
                                },
                                success: function(res) {
                                    console.log(res.data.link);

                                    var user = firebase.auth().currentUser;
                                    var pfp = res.data.link;
                                    $("document").ready(function() {

                                        firebase.database().ref('/data/users/' + user.uid).update({
                                            profile_picture: pfp
                                        });
                                        user.updateProfile({
                                            photoURL: pfp
                                        });

                                    });
                                },
                                error: function() {

                                    swal("Failed | 上传失败");
                                }
                            }
                            $.ajax(settings).done(function(response) {
                                console.log("Done | 成功");
                                swal({
                                    title: "Done",
                                    icon: "success",
                                    timer: 1500,
                                });
                            });
                        }
                    });
                });


                //////////////////////////////////////////////////////////////////////
                var user = firebase.auth().currentUser;
                var d = new Date();
                var aag = d.getTime();
                var aaf = d.getFullYear();
                var aae = d.getMonth();
                var aah = d.getMilliseconds();
                var aahx = d.getDay();
                var create_link = aag + "" + aaf + "" + aae + "" + aah + "" + aahx


                $("[id=edit_profile]").click(function() {
                    var rxxf = firebase.database().ref('/data/users/');

                    rxxf.child(id).on('value', function(snapshot) {
                        var foll = snapshot.val();
                        $('#in-name').val(foll.username);
                        $('#in-bio').val(foll.bio);
                        var cos = foll.bio;
                        $('#text-bio').text(cos);

                        const {
                            value: formValues
                        } = Swal.fire({
                            title: 'Update Profile',
                            html: '<input id="swal-input1" placeholder="Name || Only 20 Letters " value="' + foll.username + '" class="swal2-input">' +
                                '<input id="swal-input2" value="' + foll.bio + '" class="swal2-input">',
                            focusConfirm: false,
                            confirmButtonText: "Save",
                            allowOutsideClick: false,
                            preConfirm: () => {
                                var user = firebase.auth().currentUser;
                                var name = $('#swal-input1').val();
                                var bio = $('#swal-input2').val();
                                var refo = firebase.database().ref('/data/users/' + user.uid);
                                refo.update({
                                    bio: bio,
                                }).catch(function(error) {
                                    swal("WEEBOO!!?", "Only 80 Letter's are allowed || For Bio", "error", {
                                        className: "black",
                                        closeOnClickOutside: false
                                    });
                                });
                                refo.update({
                                    username: name,
                                }).catch(function(error) {
                                    swal("WEEBOO!!?", "Only 20 Letter's are allowed || For Name", "error", {
                                        className: "black",
                                        closeOnClickOutside: false
                                    });
                                });
                                user.updateProfile({
                                    displayName: name,
                                })
                            }
                        }).then(function() {
                            // Update successful.
                            swal(name, "User Profile Updated Successfully ", "success", {
                                className: "black",
                                closeOnClickOutside: false
                            });

                        }).catch(function(error) {
                            alert('ERROR'); // An error happened.
                        });

                    });

                });

                var rxxf = firebase.database().ref('/data/users/');
                rxxf.child(id).on('value', function(snapshot) {
                    var foll = snapshot.val();

                    $('#in-name').val(foll.username);

                    $('#in-bio').val(foll.bio);
                    var cos = foll.bio;
                    var cosx = foll.username;
                    $('#text-bio').text(cos);
                    if (cosx == 0) {
                        const {
                            value: formValues
                        } = Swal.fire({
                            title: 'Blank Name is Not allowed',
                            html: '<input id="swal-input1" placeholder="Display Name" value="' + foll.username + '" class="swal2-input">',
                            focusConfirm: false,

                            preConfirm: () => {
                                var user = firebase.auth().currentUser;
                                var name = $('#swal-input1').val();
                                var bio = $('#swal-input2').val();
                                firebase.database().ref('/data/users/' + user.uid).update({
                                    username: name,
                                });
                                user.updateProfile({
                                    displayName: name,
                                }).then(function() {
                                    // Update successful.
                                    swal(name, "User Profile Updated Successfully ", "success", {
                                        className: "black",
                                        closeOnClickOutside: false
                                    });

                                }).catch(function(error) {
                                    alert('ERROR'); // An error happened.
                                });

                            }
                        })
                    }
                });

                var user = firebase.auth().currentUser;
                var ref = firebase.database().ref('/data/users/' + user.uid);

                ref.update({
                    onlineState: true,
                    status: "Online",
                    StateTime: timeNow

                });
                ref.onDisconnect().update({
                    onlineState: false,
                    status: "Offline",
                    StateTime: timeNow
                });

                if (id == user.uid) {

                    var rxxf = firebase.database().ref('/data/users/');
                    rxxf.child(user.uid + '/followers/').on('value', function(snapshot) {
                        var foll = snapshot.numChildren();
                        $("[id=followers_button]").text(foll);
                    });

                    rxxf.child(user.uid + '/followers/').once('value', function(snapshot) {
                        snapshot.forEach((user) => {
                            var users = user.val().id;
                            var page = "";
                            var cx = '<userhash class="" id=""><statusdot class="follolist" id="statuso-' + users + '"></statusdot><pfp class="" id="pfp-' + users + '"></pfp><dname class="" id="dname-' + users + '">SyeraChan</dname><no class="followx" ><a href="/user?id=' + users + '">Open</a></no></userhash>';
                            $(cx).appendTo($("[id=datafoll]"));
                        });
                    });

                    rxxf.child(user.uid + '/following/').on('value', function(snapshot) {
                        var foll = snapshot.numChildren();
                        $("[id=following_button]").text(foll);
                    });

                    rxxf.child(user.uid + '/following/').once('value', function(snapshot) {
                        snapshot.forEach((user) => {
                            var users = user.val().id;
                            var cx = '<userhash class="" id=""><statusdot class="follolist" id="statuso-' + users + '"></statusdot><pfp class="" id="pfp-' + users + '"></pfp><dname class="" id="dname-' + users + '">SyeraChan</dname><no class="followx" ><a href="/user?id=' + users + '">Open</a></no></userhash>';
                            $(cx).appendTo($("[id=datafolling]"));
                        });
                    });



                } else {


                    var rxxf = firebase.database().ref('/data/users/');
                    rxxf.child(id + '/followers/').on('value', function(snapshot) {
                        var foll = snapshot.numChildren();
                        $("[id=followers_button]").text(foll);
                    });

                    rxxf.child(id + '/followers/').once('value', function(snapshot) {
                        snapshot.forEach((user) => {
                            var users = user.val().id;
                            var page = "";
                            var cx = '<userhash class="" id=""><statusdot class="follolist" id="statuso-' + users + '"></statusdot><pfp class="" id="pfp-' + users + '"></pfp><dname class="" id="dname-' + users + '">SyeraChan</dname><no class="followx" ><a href="/user?id=' + users + '">Open</a></no></userhash>';
                            $(cx).appendTo($("[id=datafoll]"));
                        });
                    });

                    rxxf.child(id + '/following/').on('value', function(snapshot) {
                        var foll = snapshot.numChildren();
                        $("[id=following_button]").text(foll);
                    });

                    rxxf.child(id + '/following/').once('value', function(snapshot) {
                        snapshot.forEach((user) => {
                            var users = user.val().id;
                            var cx = '<userhash class="" id=""><statusdot class="follolist" id="statuso-' + users + '"></statusdot><pfp class="" id="pfp-' + users + '"></pfp><dname class="" id="dname-' + users + '">SyeraChan</dname><no class="followx" ><a href="/user?id=' + users + '">Open</a></no></userhash>';
                            $(cx).appendTo($("[id=datafolling]"));
                        });
                    });

                }
            };


            var ruf = firebase.database().ref('/data/users/' + user.uid + '/following/' + id);
            var rxf = firebase.database().ref('/data/users/' + id + '/followers/' + user.uid);


            ruf.on('value', function(snapshot) {
                var follow = (snapshot.val() && snapshot.val().follow);

                if (follow == true) {
                    $("[id=follow_button]").text("Unfollow");
                } else {
                    $("[id=follow_button]").text("Follow");
                };

            });

            $("[id=follow_button]").click(function() {
                ruf.once('value', function(snapshot) {
                    var follow = (snapshot.val() && snapshot.val().follow);
                    if (follow == true) {
                        ruf.remove();
                    } else {
                        ruf.update({
                            follow: true,
                            id: id,
                        });
                    };
                });
                rxf.once('value', function(snapshot) {
                    var follow = (snapshot.val() && snapshot.val().follow);
                    if (follow == true) {
                        rxf.remove();
                    } else {
                        rxf.update({
                            follow: true,
                            id: user.uid,
                        });
                    };
                });

            });

        });

        var db_ref = firebase.database().ref('/data/users/' + id);
        db_ref.child('badges').on('value', function(snapshot) {
            console.log('working badges');
            var verified = (snapshot.val() && snapshot.val().verified);
            if (verified == true) {
                $('[id=user_badges]').html(icon_verified);
                $('[add_verified]').text("Remove Verification Mark");
            } else {
                $('[id=user_badges]').html("");
                $('[add_verified]').text("Add Verification Mark");
            }
        });

        db_ref.on('value', function(snapshot) {
            var username = (snapshot.val() && snapshot.val().username);
            var profile_picture = (snapshot.val() && snapshot.val().profile_picture);
            var banner = (snapshot.val() && snapshot.val().banner);
            var bio = (snapshot.val() && snapshot.val().bio);
            var onlineState = (snapshot.val() && snapshot.val().onlineState);

            if (onlineState == true) {
                $('[id=user_status]').addClass("rambo");
                $('[id=user_status]').text('Online');
            } else {
                $('[id=user_status]').css('background-color', 'var(--c11)');
                $('[id=user_status]').text('Offline');
            };
            $("[id=user_name]").text(username);
            $("[id=user_dec]").text(bio);
            $('[id=user_banner]').css('background-image', 'url(' + banner + '),url(/images/banner.png)');
            $('[id=user_profile_pic]').css('background-image', 'url(' + profile_picture + '),url(/images/icon.png)');
            // ...

            /////////////////////////HEAD////////////////////
            var ghk = "'s";
            var llk = '<title>' + username + '' + ghk + ' Profile - on AnimeKeyo</title><link rel="shortcut icon" href="' + profile_picture + '"><meta name="description" content="' + bio + '"><meta name="author" content="' + username + '">';

            $("[id=thehead]").prepend(llk);


            ////////////////////////////////////////////////
        });
    </script>
</body>
</body>

</html>