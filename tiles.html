<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url("/styles/main.css");
        .theme-45FFDWEQArR3 {
            width: 527px;
            height: fit-content;
            background: #151A21;
            border-radius: 8px;
            color: white;
        }
        
        .theme-45FFDtEQAKR3 {
            margin: 2.5rem;
            display: flex;
            margin-bottom: 3.5rem;
            justify-content: flex-start;
        }
        
        .theme-45FFDWpQAKR3,
        .theme-45FFDtEQAKR3 {
            gap: 1rem;
        }
        
        .theme-4yFFDWEQAKR3 {
            gap: .5rem;
        }
        
        .theme-45sFDWEQAKR3 {
            font-family: 'C1';
            font-style: normal;
            font-weight: bold;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            text-decoration-line: underline;
            color: #DEE3EA;
        }
        
        .theme-4yFFDWEQAKR3,
        .theme-45FFDtEQAKR3,
        .theme-45FFDWpQAKR3,
        .theme-45FFDWoQAKR3 {
            align-items: flex-start;
        }
        
        .theme-45FFDWoQAKR3 {
            font-family: 'C1';
            font-style: normal;
            font-weight: 500;
            font-size: 14px;
            line-height: 22px;
            color: #5D7290;
            background: #242C37;
            border: 1px solid #242C37;
            box-sizing: border-box;
            border-radius: 8px;
            /* width: fit-content; */
            padding: 19px;
            height: 40px;
        }
        
        .theme-45uFDWEQAKR3 {
            font-family: 'C1';
            font-style: normal;
            font-weight: bold;
            font-size: 20px;
            line-height: 32px;
            color: #DEE3EA;
        }
        
        .theme-45iFDWEQAKR3 {
            font-family: 'C1';
            font-style: normal;
            font-weight: 500;
            font-size: 14px;
            line-height: 22px;
            color: #5D7290;
        }
        
        .theme-45FGDWoQAKR3 {
            width: 447px;
            height: 100px;
            /* left: 40px; */
            /* top: 194px; */
            background: #242C37;
            border-radius: 8px;
            border: unset;
            display: block;
            color: white;
        }
        
        .theme-45FFDWpQAKR3 {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        
        .theme-45aFDWEQAKR3 {
            width: 176px;
            height: 38px;
            background: #FD4D4D;
            border-radius: 8px;
            font-family: 'C1';
            font-style: normal;
            font-weight: bold;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            color: #FFFFFF;
        }
    </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.7/dist/sweetalert2.all.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-analytics.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-app.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-auth.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-database.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/scripts/purl.js"></script>
<script src="/scripts/firebase.js"></script>

</head>

<body>
    <div class="center-flex theme-45FFDWEQArR3">
        <div class="full-wh center-flex theme-45FFDtEQAKR3">
            <div class="center-flex theme-4yFFDWEQAKR3">
                <div class="center-flex theme-45uFDWEQAKR3">
                    Create a post
                </div>
                <div class="center-flex theme-45iFDWEQAKR3">
                    Fill the following fields to create a new post
                </div>
            </div>
            <div class="center-flex theme-45FFDWoQAKR3" click_upload_image>
                Upload Image
            </div>
            <input class="theme-45FGDWoQAKR3" type="text" dec_input>
            <div class="center-flex theme-45FFDWpQAKR3">
                <div go class="center-flex theme-45aFDWEQAKR3">
                    Create post
                </div>
                <div class="center-flex theme-45sFDWEQAKR3">
                    Cancel
                </div>
            </div>
        </div>
    </div>
    <input style="display: none;" upload_image type="file" class="imgur" accept="image/*" data-max-size="5000" />
    <hidden hidden></hidden>
    <script data-cfasync="false" type="text/javascript">
        function timeDifference(current, previous) {

            var sPerMinute = 60;
            var sPerHour = sPerMinute * 60;
            var sPerDay = sPerHour * 24;
            var sPerMonth = sPerDay * 30;
            var sPerYear = sPerDay * 365;

            var elapsed = current - previous;
            if (elapsed < sPerMinute) {
                var output = Math.round(elapsed);
                if (output == 1) {
                    return Math.round(elapsed) + ' sec ago';
                } else {
                    return Math.round(elapsed) + ' secs ago';
                }
            } else if (elapsed < sPerHour) {
                var output = Math.round(elapsed / sPerMinute);
                if (output == 1) {
                    return Math.round(elapsed / sPerMinute) + ' min ago';
                } else {
                    return Math.round(elapsed / sPerMinute) + ' mins ago';
                }
            } else if (elapsed < sPerDay) {
                var output = Math.round(elapsed / sPerHour);
                if (output == 1) {
                    return Math.round(elapsed / sPerHour) + ' hr ago';
                } else {
                    return Math.round(elapsed / sPerHour) + ' hrs ago';
                }
            } else if (elapsed < sPerMonth) {
                var output = Math.round(elapsed / sPerDay);
                if (output == 1) {
                    return Math.round(elapsed / sPerDay) + ' day ago';
                } else {
                    return Math.round(elapsed / sPerDay) + ' days ago';
                }
            } else if (elapsed < sPerYear) {
                var output = Math.round(elapsed / sPerMonth);
                if (output == 1) {
                    return Math.round(elapsed / sPerMonth) + ' month ago';
                } else {
                    return Math.round(elapsed / sPerMonth) + ' months ago';
                }
            } else {
                var output = Math.round(elapsed / sPerYear);
                if (output == 1) {
                    return Math.round(elapsed / sPerYear) + ' year ago';
                } else {
                    return Math.round(elapsed / sPerYear) + ' years ago';

                }
            }
        }
    </script>
    <script>
        $('[click_upload_image]').click(function() {
            $('[upload_image]').trigger('click');
        });
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {

                var ddb = firebase.firestore();
                ddb.collection("users").doc(user.uid).collection("posts").get()
                    .then(querySnapshot => {
                        querySnapshot.forEach(doc => {
                            //////////////////////////////////////////////////////////
                            var current = Math.round((new Date()).getTime() / 1000);
                            setTimeout(
                                function() {
                                    var elements = document.getElementsByClassName("timeS");
                                    for (var i = 0; i < elements.length; i++) {
                                        var previous = elements[i].getAttribute("time");
                                        elements[i].innerHTML = timeDifference(current, previous);

                                        if ((current - previous) < 86400) {
                                            elements[i].parentNode.parentNode.classList.add("red-background");
                                        }
                                    }
                                }, 0100);
                            ///////////////////////////////////////////////////////////
                            console.log(doc.id);
                            const dec = doc.data().dec;
                            const time = doc.data().time;
                            console.log(dec);
                            const cx = '<time class="timeS" time="' + time + '"></time><div>' + dec + '</div>';
                            $("[postlist]").prepend(cx);
                        });
                    });

                //////////////////////////////////////
                let db = firebase.firestore().collection("users");
                db.doc(user.uid).set({
                    id: user.uid,
                    name: user.displayName,
                });
                $("document").ready(function() {

                    $('[upload_image]').on("change", function() {

                        var $files = $(this).get(0).files;

                        if ($files.length) {

                            // Reject big files
                            if ($files[0].size > $(this).data("max-size") * 1024) {
                                console.log("Please select a smaller file");
                                return false;
                            }

                            // Replace ctrlq with your own API key
                            var apiUrl = 'https://api.imgur.com/3/image';
                            var apiKey = '4b208caca83b4c4';

                            var formData = new FormData();
                            formData.append("image", $files[0]);

                            var settings = {
                                "async": true,
                                "crossDomain": true,
                                "url": apiUrl,
                                "method": "POST",
                                "datatype": "json",
                                "headers": {
                                    "Authorization": "Client-ID " + apiKey
                                },
                                "processData": false,
                                "contentType": false,
                                "data": formData,
                                beforeSend: function(xhr) {
                                    swal({
                                        text: "Uploading",
                                        buttons: false,
                                        closeOnClickOutside: false,
                                    });
                                },
                                success: function(res) {
                                    console.log(res.data.link);
                                    $('[hidden]').html('<img postimgdata src="' + res.data.link + '">');

                                },
                                error: function() {

                                    swal("Failed | 上传失败");
                                }
                            }
                            $.ajax(settings).done(function(response) {
                                console.log("Done | 成功");
                                swal({
                                    title: "Done",
                                    icon: "success",
                                    timer: 1500,
                                });
                            });
                        }
                    });
                });

                $('[go]').on('click', function() {
                    var d = new Date();
                    var aag = d.getTime();
                    var aaf = d.getFullYear();
                    var aae = d.getMonth();
                    var aah = d.getMilliseconds();
                    var aahx = d.getDay();

                    str = Date.now();
                    str = str.toString();
                    str = str.slice(0, -3);
                    str = parseInt(str);
                    var create_link = aag + "" + aaf + "" + aae + "" + aah + "" + aahx;
                    var date = str;

                    const dec = $('[dec_input]').val();
                    const link = create_link;
                    const img = $('[postimgdata]').attr('src');

                    if (typeof img == "undefined" || dec == "0") {
                        swal({
                            text: "You have to select an image first",
                            buttons: false,
                            closeOnClickOutside: false,
                            timer: 1500,
                        });
                    } else {
                        db.doc(user.uid + '/posts/' + create_link).set({
                            userid: user.uid,
                            link: link,
                            img: img,
                            dec: dec,
                            time: date,
                        });
                    };

                });
            } else {

            }
        });
    </script>
</body>

</html>