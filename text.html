<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.7/dist/sweetalert2.all.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-analytics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-auth.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase-database.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.3.2/firebase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/scripts/purl.js"></script>
    <script src="/scripts/firebase.js"></script>

</head>

<body>
    <div postlist>
    </div>
    <input type="text" name="" name_text>
    <input id="uploadpostimg" type="file" class="imgur" accept="image/*" data-max-size="5000" />
    <a go>ssssssssssssssssss</a>
    <hidden id="hidden"></hidden>
    <script data-cfasync="false" type="text/javascript">
        function timeDifference(current, previous) {

            var sPerMinute = 60;
            var sPerHour = sPerMinute * 60;
            var sPerDay = sPerHour * 24;
            var sPerMonth = sPerDay * 30;
            var sPerYear = sPerDay * 365;

            var elapsed = current - previous;
            if (elapsed < sPerMinute) {
                var output = Math.round(elapsed);
                if (output == 1) {
                    return Math.round(elapsed) + ' sec ago';
                } else {
                    return Math.round(elapsed) + ' secs ago';
                }
            } else if (elapsed < sPerHour) {
                var output = Math.round(elapsed / sPerMinute);
                if (output == 1) {
                    return Math.round(elapsed / sPerMinute) + ' min ago';
                } else {
                    return Math.round(elapsed / sPerMinute) + ' mins ago';
                }
            } else if (elapsed < sPerDay) {
                var output = Math.round(elapsed / sPerHour);
                if (output == 1) {
                    return Math.round(elapsed / sPerHour) + ' hr ago';
                } else {
                    return Math.round(elapsed / sPerHour) + ' hrs ago';
                }
            } else if (elapsed < sPerMonth) {
                var output = Math.round(elapsed / sPerDay);
                if (output == 1) {
                    return Math.round(elapsed / sPerDay) + ' day ago';
                } else {
                    return Math.round(elapsed / sPerDay) + ' days ago';
                }
            } else if (elapsed < sPerYear) {
                var output = Math.round(elapsed / sPerMonth);
                if (output == 1) {
                    return Math.round(elapsed / sPerMonth) + ' month ago';
                } else {
                    return Math.round(elapsed / sPerMonth) + ' months ago';
                }
            } else {
                var output = Math.round(elapsed / sPerYear);
                if (output == 1) {
                    return Math.round(elapsed / sPerYear) + ' year ago';
                } else {
                    return Math.round(elapsed / sPerYear) + ' years ago';

                }
            }
        }
    </script>
    <script>
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {

                var ddb = firebase.firestore();
                ddb.collection("users").doc(user.uid).collection("posts").get()
                    .then(querySnapshot => {
                        querySnapshot.forEach(doc => {
                            //////////////////////////////////////////////////////////
                            var current = Math.round((new Date()).getTime() / 1000);
                            setTimeout(
                                function() {
                                    var elements = document.getElementsByClassName("timeS");
                                    for (var i = 0; i < elements.length; i++) {
                                        var previous = elements[i].getAttribute("time");
                                        elements[i].innerHTML = timeDifference(current, previous);

                                        if ((current - previous) < 86400) {
                                            elements[i].parentNode.parentNode.classList.add("red-background");
                                        }
                                    }
                                }, 0100);
                            ///////////////////////////////////////////////////////////
                            console.log(doc.id);
                            const dec = doc.data().dec;
                            const time = doc.data().time;
                            console.log(dec);
                            const cx = '<time class="timeS" time="' + time + '"></time><div>' + dec + '</div>';
                            $("[postlist]").prepend(cx);
                        });
                    });

                //////////////////////////////////////
                let db = firebase.firestore().collection("users");
                db.doc(user.uid).set({
                    id: user.uid,
                    name: user.displayName,
                });
                $("document").ready(function() {

                    $('input[id=uploadpostimg]').on("change", function() {

                        var $files = $(this).get(0).files;

                        if ($files.length) {

                            // Reject big files
                            if ($files[0].size > $(this).data("max-size") * 1024) {
                                console.log("Please select a smaller file");
                                return false;
                            }

                            // Replace ctrlq with your own API key
                            var apiUrl = 'https://api.imgur.com/3/image';
                            var apiKey = '4b208caca83b4c4';

                            var formData = new FormData();
                            formData.append("image", $files[0]);

                            var settings = {
                                "async": true,
                                "crossDomain": true,
                                "url": apiUrl,
                                "method": "POST",
                                "datatype": "json",
                                "headers": {
                                    "Authorization": "Client-ID " + apiKey
                                },
                                "processData": false,
                                "contentType": false,
                                "data": formData,
                                beforeSend: function(xhr) {
                                    swal({
                                        text: "Uploading",
                                        buttons: false,
                                        closeOnClickOutside: false,
                                    });
                                },
                                success: function(res) {
                                    console.log(res.data.link);
                                    $('#hidden').html('<img class="post-dec-img" id="postimgdata" src="' + res.data.link + '">');

                                },
                                error: function() {

                                    swal("Failed | 上传失败");
                                }
                            }
                            $.ajax(settings).done(function(response) {
                                console.log("Done | 成功");
                                swal({
                                    title: "Done",
                                    icon: "success",
                                    timer: 1500,
                                });
                            });
                        }
                    });
                });

                $('[go]').on('click', function() {
                    var d = new Date();
                    var aag = d.getTime();
                    var aaf = d.getFullYear();
                    var aae = d.getMonth();
                    var aah = d.getMilliseconds();
                    var aahx = d.getDay();

                    str = Date.now();
                    str = str.toString();
                    str = str.slice(0, -3);
                    str = parseInt(str);

                    var date = str;

                    var create_link = aag + "" + aaf + "" + aae + "" + aah + "" + aahx;
                    const ad = $('[name_text]').val();
                    const al = create_link;
                    const ai = "img";
                    db.doc(user.uid + '/posts/' + create_link).set({
                        userid: user.uid,
                        link: al,
                        img: ai,
                        dec: ad,
                        time: date,
                    });

                });
            } else {

            }
        });
    </script>
</body>

</html>